---
title: Kernel Exploit Basic
date: 2018-09-17 17:19:53
categories:
- Kernel Exploit
tags:
- Kernel Exploit Basic
---

Kernel Exploit Basic



## Ring Model (특권 레벨)

0에서 부터 시작하고 CPU와 운영체제에 따라서 레벨을 정한다.

레벨 숫다가 높은 쪽일 수록 권한이 점점 줄어든다.

Ring 0: 커널모드 mode bit = 0

Ring 3: 유저모드 mode bit = 1 



## Kernel Exploit

1. 커널 취약점 찾기
2. code 실행할 수 있도록 조작하기
3. 프로세스의 privilege level 상승시키기
4. user 영역으로 돌아갈 trap frame 생성 후 돌아가 쉘 실행
5. root 권한 획득



## Loadable Kernel Module (LKM)

#### commands

lsmod: 실행중인 모듈들의 리스트

insmod <커널 모듈>: 커널에 모듈 삽입

modinfo <커널 모듈>: 모듈 정보

rmmod <커널 모듈>: 모듈 삭제



#### functions

module_init: 모듈 적재할 때 실행되는 함수, 모든 init 함수는 int 형을 반환해야 한다. 성공하면 0 반환

module_exit: 모듈 삭제할 때 실행되는 함수

printk: printf대신 사용, 주로 디버깅 목적으로 사용됨, flag로 우선순위를 정할 수 있다.

	printf: 출력 대상이 표준 출력 디바이스인 모니터 

	printk: 출력 대상이 커널이 실행중인 4GB 영역의 메모리 (tty가 아닌 pts로 출력)

	dmesg 또는 cat /var/log/messages 로 확인

MODULE_LICENSE("GPL"): license 정보 매크로, 쓸데 없는 경고 메세지 출력 방지

copy_from_user, copy_to_user: memcpy와 비슷한 기능

kmalloc: malloc 과 비슷한 기능




## Elevate Privileges

#### /proc/kallsyms

현재 실행중인 커널 메모리 영역에 포함된 모든 심볼(메모리에 등록된 함수와 전역변수 이름) 정보 관리
커널 내부에서 모두 쓰레드로 실행이 되어, 함수나 전역 변수의 이름들이 같은 메모리 영역을 공유하게 된다.
따라서 심볼이 중복될 경우 어떤 심볼을 참조해야 하는 지 문제가 생김




#### commit_creds(prepare_kernel_cred(0)) 

프로세스의 정보를 담고 있는 task_struct 구조체에 credential struct 라는 구조체가 있다.

이 cred 구조체 안에 uid, gid, suid ... 를 담고 있다.

prepare_kernel_cred() 함수는 이 cred structure 를 만들어주고, 0을 인자로 주면 uid, gid,,, 가 초기화된 cred structure 를 반환해 준다. (uid=0: root)

commit_creds() 함수는 인자로 받은 cred structure을 new cred structure로 바꿔준다.

따라서 commit_creds(prepare_kernel_cred(0)) 를 실행하면 root로 권한 상승을 할 수 있다.



## Return to UserSpace

유저모드에서 커널모드로 갈때 trap frame 을 스택에 저장하고 다시 유저모드로 돌아올 때 스택에 저장해 두었던 trap frame 을 가져와 실행을 이어간다. 따라서 유저모드에서 쉘 실행전에 fake trap frame을 만들어 주어야 한다.

```asm
	push $SS_USER_VALUE
	push $USERLAND_STACK
	push $USERLAND_EFLAGS
	push $CS_USER_VALUE
	push $USERLAND_FUNCTION_ADDRESS
	swapgs
	iretq
```

```c
void prepare_tf(void) {
    asm("xorq %rax, %rax;\n"
        "movw %cs, %ax;\n"
        "movq %rax, tf+8;\n"
        "pushfq;   popq tf+16;\n"
        "movw %ss, %ax;\n"
        "movq %rax, tf+32;\n");
    tf.rip = &get_shell;
    tf.rsp -= 1024;
}
void payload(void){
    commit_creds(prepare_kernel_cred(0));
    //asm("mov $tf, %esp; iret;");
    asm("mov $tf, %rsp;\n"
            "swapgs;\n"
            "iretq;");
}
```



## Kernel Space Protection

MMAP_MIN_ADDR: mmap을 할 수 있는 최소 주소를 정해 null pointer deterences 공격 방지

KALLSYMS: 공격에 사용되는 심볼을 주는 /proc/kallsyms 정보를 0으로 세팅

KASLR: 유저모드에서 ASLR 과 같음. 주소 랜덤

SMEP/SMAP: 커널모드에서 user bit 이 세팅된 영역을 실행하는것을 방지 (ROP로 우회 가능)



#### 보호기법 확인
```
mmap_min_addr : sysctl -a | grep vm.mmap

smep : cat /proc/cpuinfo | grep smep

kaslr : cat /proc/kallsyms | grep _text | head -n 1
```

#   





reference

	http://security.cs.rpi.edu/courses/binexp-spring2015/lectures/23/13_lecture.pdf
	http://ashesmin.tistory.com/7
	http://richong.tistory.com/307
	http://moldd.tistory.com/entry/%EC%BB%A4%EB%84%90-%EB%A0%88%EC%9D%B4%EC%95%84%EC%9B%83

